# ----- Core settings -----
export EDITOR="nvim"
export LANG=en_US.UTF-8
export HOMEBREW_NO_AUTO_UPDATE=1

# Avoid duplicate PATH entries (Zsh-native deduplication)
typeset -U PATH

# Path additions
export PATH="/usr/local/sbin:$PATH"
export PATH="$HOME/.cargo/bin:$PATH"

# ----- Oh My Zsh -----
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"
plugins=(
  brew
  docker
  extract
  fast-syntax-highlighting
  fzf
  git
  github
  gitfast
  macos
  nmap
  node
  npm
  pip
  python
  tmux
  vi-mode
  vscode
)
DISABLE_AUTO_UPDATE="true"
DISABLE_UPDATE_PROMPT="true"
ENABLE_CORRECTION="true"
source $ZSH/oh-my-zsh.sh

# ----- History -----
HISTSIZE=1000000
SAVEHIST=1000000
HISTFILE=$HOME/.zsh_history
setopt EXTENDED_HISTORY SHARE_HISTORY HIST_IGNORE_DUPS HIST_IGNORE_SPACE \
       HIST_VERIFY HIST_REDUCE_BLANKS HIST_EXPIRE_DUPS_FIRST \
       INC_APPEND_HISTORY APPEND_HISTORY

# ----- Aliases -----
alias path='echo -e ${PATH//:/\\n}'
alias ports='netstat -tulanp'
alias bash="/opt/homebrew/bin/bash"

# ----- Completion -----
autoload -Uz compinit && compinit
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'

# ----- Directory navigation -----
setopt AUTO_CD AUTO_PUSHD PUSHD_IGNORE_DUPS PUSHD_SILENT

# ----- fzf -----
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --preview 'bat --style=numbers --color=always --line-range :500 {}'"
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window up:3:hidden:wrap --bind '?:toggle-preview'"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
set -o vi
bindkey -s '^o' 'nvim $(fzf)\n'

# ----- pyenv -----
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
if command -v pyenv >/dev/null; then
  eval "$(pyenv init --path)"
  eval "$(pyenv virtualenv-init -)"
fi

# ----- rbenv -----
if command -v rbenv >/dev/null; then
  export PATH="/usr/local/opt/ruby/bin:$PATH"
  eval "$(rbenv init - zsh)"
fi

# ----- NVM (lazy load) -----
export NVM_DIR="$HOME/.nvm"
# Lazy-load NVM only when `nvm`, `node`, or `npm` is first used
lazy_nvm() {
  unset -f nvm node npm
  [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
}
nvm() { lazy_nvm; nvm "$@"; }
node() { lazy_nvm; node "$@"; }
npm() { lazy_nvm; npm "$@"; }

# ----- broot -----
[ -f "$HOME/.config/broot/launcher/zsh/br" ] && source "$HOME/.config/broot/launcher/zsh/br"

# ----- zoxide -----
eval "$(zoxide init zsh)"

# ----- fast-syntax-highlighting -----
source /opt/homebrew/opt/zsh-fast-syntax-highlighting/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh

# Ensure HISTTIMEFORMAT stays unset (Bash-only var, but harmless to unset)
unset HISTTIMEFORMAT
